---
title: "è¦–è¦ºåŒ–çš„èªè¨€å¿ƒæ³•â€”è³‡æ–™ã€æ¨¡å‹ã€èˆ‡æºé€š"
author: "Leo Lu"
date: '`r Sys.Date()`'
output: 
  rmdshower::shower_presentation:
    ratio: 16x10
    self_contained: true
    theme: material
    katex: false  # formula rendering, but slow. turn on if needed
    highlight: pygments
    css: css/shower.css
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
library(knitr)
knitr::opts_chunk$set(warning = FALSE,
                      echo = TRUE,
                      message = FALSE,
                      collapse = FALSE,
                      comment = "#>",
                      fig.align='center',
                      cache=FALSE)
## knitr::opts_knit$set(root.dir = '.')
library(data.table)
library(magrittr)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2); theme_set(theme_grey()) 
library(gapminder)
library(cowplot)
```


## <br/>è¦–è¦ºåŒ–çš„èªè¨€å¿ƒæ³•â€”è³‡æ–™ã€æ¨¡å‹ã€èˆ‡æºé€š {.white}

<img src="img/reptile.jpg" class="cover">
<p class="white">
`r Sys.Date()`<br/>
</p>
<p style='color:white'>
  å‘‚å¥• [Leo Lu](https://github.com/leoluyi)
</p>


## How to use this slides

- Press **Esc** to navigation mode
- Press **pageDown**, **Right** or **Down** to go to next slide
- Presss **PageUP**, **Left** or **Up** to go to previous slide

## ä¸€å€‹ä¾‹å­å­¸æœƒç•«åœ–ï¼šmpg ğŸš—æ²¹è€—è³‡æ–™

- `mpg` dataset: Fuel economy data from 1999 and 2008 for 38 popular models of car.

| variable     | detail                                               |
|--------------|------------------------------------------------------|
| manufacturer | è»Šå»                                                  |
| model        | å‹è™Ÿ                                                 |
| displ        | å¼•æ“æ’æ°£é‡                                           |
| year         | å‡ºå» å¹´ä»½                                             |
| cyl          | æ°£ç¼¸æ•¸                                               |
| trans        | è‡ªï¼æ‰‹æ’                                             |
| drv          | f = front-wheel drive, r = rear wheel drive, 4 = 4wd |
| cty          | city miles per gallon åŸå¸‚é§•é§›æ²¹è€—                   |
| hwy          | highway miles per gallon é«˜é€Ÿå…¬è·¯é§•é§›æ²¹è€—            |
| fl           | æ±½æ²¹: ethanol E85, diesel, regular, premium, CNG     |
| class        | è»Šå‹                                                 |


## Aesthetic Mappings

```{r, eval=FALSE}
ggplot(data = <DATA>) + # Data
  geom_<xxx>(
     mapping = aes(<MAPPINGS>), ##  <= Aesthetic mappings
     stat = <STAT>,
     position = <POSITION>
  ) +
  scale_<xxx>() + coord_<xxx>() + facet_<xxx>()
  theme_()
```

## Aesthetics åŸºæœ¬ç”¨æ³•

>- x = displ
>- y = hwy
>- color = class

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class), size = 3)
```

## Aesthetics åŸºæœ¬ç”¨æ³•

- x = displ
- y = hwy
- shape = class

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```


# ggplot2 å¨åŠ›é‚„ä¸åªé€™äº›

## Layers åœ–å±¤è§€å¿µ

- å…©å±¤åœ–å±¤

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  geom_smooth(mapping= aes(x = displ, y = hwy))
```


## Too many variables!!!!

- å¤šäº†ç¬¬3å€‹è®Šæ•¸ï¼Œæ‰€ä»¥æ›´é›£ç†è§£äº†

```{r, echo=FALSE, fig.asp=0.35, fig.width=10}
p1 <- ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "stack") +
  ggtitle('Position = "stack"')
p2 <- ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "dodge") +
  ggtitle('Position = "dodge"')
cowplot::plot_grid(p1, p2)
```

## Facets: Small-Multiples

- Facets æ˜¯å¾ˆé‡è¦çš„ä¸€å€‹å‘ˆç¾æ–¹å¼ï¼Œä¸€å®šè¦å­¸èµ·ä¾†
- ç‚ºä»€éº¼è¦ç”¨ Facetsï¼Ÿ
    1. ç•¶åŒä¸€å€‹åº§æ¨™å¹³é¢å¡å…¥å¤ªå¤šè®Šæ•¸ï¼Œæœƒé€ æˆå¤§è…¦ç„¡æ³•è² è·
    2. åˆ†æ‹†è³‡è¨Šï¼Œè®“å¤§è…¦å”åŠ©<underline>è…¦è£œ</underline>æ›´æœ‰æ•ˆç‡


```{r facet, fig.width=10, fig.asp=1.4}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class)) +
  facet_wrap( ~ manufacturer, ncol = 3)
```

(back to slides)
----------------

# Visualise the model

## The best stats you've ever seen | Hans Rosling { .fullpage }

<a href="https://www.youtube.com/watch?v=hVimVzgtD6w" target="_blank"><img src="img/10rosling-obit-1-master768.jpg" style="max-width:90%; max-height:70%;"></a>

## Take a look at our data

```{r}
library(gapminder)
gapminder
```

## Our ggplot

```{r echo=FALSE}
library(gapminder)
ggplot(gapminder, aes(year, lifeExp, group = country)) +
  geom_line() +
  ggtitle("Life expectanty by each country")
```


## Fit a model to each country { .fullpage }

<img src="img/broom_purrr.png" style="max-width:90%; max-height:70%;">

## R packages

1. Nested data (`tidyr`)
2. Functional programming (`purrr`)
3. Models â†’ tidy data (`broom`)

## Split our data into data.frames by group

<img src="img/dataframe_split.png" style="max-width:90%; max-height:70%;">

## Split our data

```{r}
library(dplyr)
library(tidyr)

gapminder <- gapminder %>% mutate(year1950 = year - 1950)
by_country <- gapminder %>% 
  group_by(continent, country) %>% 
  nest

by_country
```

## Fit a model within each country

```{r eval=FALSE}
lm(lifeExp ~ year, data = Afghanistan)
lm(lifeExp ~ year, data = Afghanistan)
...

```

## We can use purrr::map() to fit each model

```{r}
library(purrr)

country_model <- function(df) {
  lm(lifeExp ~ year1950, data = df)
}

models <- by_country %>%
  mutate(mod_lm = map(data, country_model))

models
```

## What can we extract from each model?

<img src="img/broom_purrr.png" style="max-width:90%; max-height:70%;">

## Extract info from model

```{r}
models <- models %>% 
  mutate(
    glance = mod_lm %>% map(broom::glance),
    tidy = mod_lm %>% map(broom::tidy),
    augment = mod_lm %>% map(broom::augment),
    rsq = glance %>% map_dbl("r.squared")
  )
models
```

## See the R^2

```{r seeR2, fig.width=8, fig.asp=2}
models %>% 
  ggplot(aes(rsq, reorder(country, rsq))) +  # use factor levels
  geom_point(aes(colour = continent)) +
  theme(axis.text=element_text(size=rel(0.7)))
```

## Unnest to a regular data frame

```{r}
models %>% unnest(data)
```

## Unnest to a regular data frame

```{r}
models %>% unnest(glance, .drop = TRUE)
```

## Unnest to a regular data frame

```{r}
models %>% unnest(tidy, .drop = TRUE)
```


## Plot the models

```{r}
models %>% 
  unnest(tidy) %>% 
  select(continent, country, term, estimate, rsq) %>% 
  spread(key = term, value = estimate) %>% 
  ggplot(aes(`(Intercept)`, year1950)) +
  geom_point(aes(colour = continent, size = rsq)) +
  geom_smooth(se = FALSE)
```

## Plot the models: augmented

```{r}
models %>% 
  unnest(augment) %>% 
  ggplot(aes(year1950, .resid)) +
  geom_line(aes(group = country), alpha = 0.3) +
  geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0, colour = "red", alpha = 0.7) +
  facet_wrap(~continent)
```

## Quick recap for model viz

Functional programming is very powerful

1. `tidyr`: æŠŠç‰©ä»¶ (ä¾‹å¦‚ lm) ç”¨ list å­˜åœ¨ columns è£¡é¢
2. `purrr`: Functional programming
3. `broom`: Models â†’ tidy data

## { .fullpage }

![](img/plotcon2016-hadley.png)

## Reference

- [Hadley Wickham: Managing many models with R](https://www.youtube.com/watch?v=rz3_FDVt9eg)
- [PLOTCON 2016: Hadley Wickham, New open viz in R](https://www.youtube.com/watch?v=cU0-NrUxRw4)
- [Hadley Wickham "Data Science with R"](https://www.youtube.com/watch?v=K-ss_ag2k9E)
- [Cookbook for R](http://www.cookbook-r.com/Graphs/)

